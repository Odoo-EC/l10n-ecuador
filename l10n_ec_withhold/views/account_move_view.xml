<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <record model="ir.ui.view" id="account_invoice_custom_view">
        <field name="name">Facturas con retencion</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='preview_invoice']" position="before">
                <button
                    name="action_create_sale_withhold_wizard"
                    string="Add Withholding"
                    type="object"
                    class="btn-primary"
                    attrs="{'invisible': ['|', '|', '|',('state', '!=', 'posted'), ('payment_state', 'not in', ('not_paid', 'partial')), ('move_type', '!=', 'out_invoice'),('l10n_ec_withhold_active', '=', False)]}"
                />
                <button
                    name="action_create_purchase_withhold_wizard"
                    string="Add Withholding"
                    type="object"
                    class="btn-primary"
                    attrs="{'invisible': ['|', '|', '|',('state', '!=', 'posted'), ('payment_state', 'not in', ('not_paid', 'partial')), ('move_type', '!=', 'in_invoice'),('l10n_ec_withhold_active', '=', False)]}"
                />
            </xpath>
            <xpath expr="//button[@name='action_view_debit_notes']" position="after">
                <button
                    name="action_show_l10n_ec_withholds"
                    type="object"
                    class="oe_stat_button"
                    icon="fa-list-alt"
                    attrs="{'invisible':[('l10n_ec_withhold_count', '=', 0)]}"
                >
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="l10n_ec_withhold_count"/>
                        </span>
                        <span class="o_stat_text">Withholding</span>
                    </div>
                </button>
            </xpath>
            <xpath expr="//field[@name='reversed_entry_id']" position="after">
                <field name="l10n_latam_internal_type" invisible="1"/>
                <field name="l10n_ec_withhold_active" invisible="1"/>
            </xpath>
            <xpath
                expr="//field[@name='line_ids']//field[@name='name']"
                position="after"
            >
                <field name='l10n_ec_tax_support' force_save="1" optional='hidden'/>
            </xpath>

            <xpath
                expr="//field[@name='invoice_line_ids']//field[@name='analytic_account_id']"
                position="before"
            >
                <field
                    name="l10n_ec_tax_support"
                    force_save="1"
                    attrs="{'column_invisible': [('parent.move_type', '!=', 'in_invoice')]}"
                />
            </xpath>

            <xpath
                expr="//field[@name='invoice_line_ids']/form//field[@name='account_id']"
                position="after"
            >
                <field
                    name="l10n_ec_tax_support"
                    invisible="1"
                    attrs="{'column_invisible': [('parent.move_type', '!=', 'in_invoice')]}"
                />
            </xpath>
        </field>
    </record>

    <record
        id="view_account_move_withhold_tree"
        model="ir.ui.view"
    >
        <field name="name">account.move.withhold.tree</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_tree"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="create">0</attribute>
                <attribute name="delete">0</attribute>
            </xpath>
            <xpath expr="//field[@name='state']" position="after">
                <field name="l10n_ec_withholding_type" optional="hide"/>
            </xpath>
        </field>
    </record>

    <record
        id="view_account_move_withhold_form"
        model="ir.ui.view"
    >
        <field name="name">account.move.form.withhold</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="mode">primary</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='fiscal_position_id']" position="before">
                <field name="l10n_ec_withholding_type" invisible="1"/>
                <field name="is_move_sent" invisible="1"/>
            </xpath>
            <xpath expr="//button[@name='%(account.action_view_account_move_reversal)d']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='move_type']" position="before">
                <span class="o_form_label">
                    <field name="l10n_ec_withholding_type"
                           attrs="{'invisible': [('l10n_latam_internal_type', '!=', 'withhold')]}"
                           readonly="1"
                           nolabel="1"/>
                </span>
            </xpath>


            <xpath expr="//header/button[@name='action_invoice_sent']" position="before">
                <button name="action_invoice_sent"
                        type="object"
                        string="Send &amp; Print"
                        class="oe_highlight"
                        data-hotkey="y"
                        attrs="{'invisible': ['|','|',('state', '!=', 'posted'), ('l10n_latam_internal_type', '!=', 'withhold'), ('is_move_sent', '=', True)]}"/>

                <button name="action_invoice_sent"
                        type="object"
                        string="Send &amp; Print"
                        data-hotkey="y"
                        attrs="{'invisible': ['|','|',('state', '!=', 'posted'), ('l10n_latam_internal_type', '!=', 'withhold'), ('is_move_sent', '=', False)]}"/>

            </xpath>
            <xpath expr="//field[@name='ref']" position="before">
                <field
                    name="partner_id"
                    widget="res_partner_many2one"
                    context="{'show_address': 1, 'default_is_company': True, 'show_vat': True}"
                    options='{"always_reload": True, "no_quick_create": True}'
                    attrs="{'invisible': [('l10n_latam_internal_type', '!=', 'withhold')]}"
                />
            </xpath>
            <xpath expr="//group[@id='header_right_group']//field[@name='date']" position="after">
                <field
                    name="invoice_origin"
                    attrs="{'invisible':[('l10n_latam_internal_type', '!=', 'withhold')]}"/>
            </xpath>
            <xpath expr="//field[@name='ref']" position="after">
                <field
                    name="l10n_ec_electronic_authorization"
                    attrs="{'invisible':[('l10n_latam_internal_type', '!=', 'withhold')]}"/>
                <field
                    name="l10n_ec_xml_access_key"
                    attrs="{'invisible':[('l10n_latam_internal_type', '!=', 'withhold')]}"/>
            </xpath>

            <xpath expr="//page[@id='aml_tab']" position="before">
                <page
                    id="withhold_tab"
                    string="Withhold Lines"
                    attrs="{'invisible': [('l10n_latam_internal_type', '!=', 'withhold')]}"
                >
                    <field name="l10n_ec_withhold_line_ids" mode="tree,kanban">
                        <tree editable="bottom">
                            <field name="company_id" invisible='1'/>
                            <field name="tax_line_id"/>
                            <field name="tax_base_amount" string="Monto base"/>
                            <field name="balance" string="Monto retenido"/>
                        </tree>
                    </field>
                    <field
                        name="narration"
                        placeholder="Add an internal note..."
                        nolabel="1"
                        height="50"
                    />
                </page>
            </xpath>
        </field>
    </record>


    <record
        id="action_account_move_purchase_withhold"
        model="ir.actions.act_window"
    >
        <field name="name">Purchase Withholds</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('l10n_ec_withhold.view_account_move_withhold_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('l10n_ec_withhold.view_account_move_withhold_form')})]"/>
        <field name="domain">[('l10n_ec_withholding_type', '=', 'purchase')]</field>
    </record>

    <record
        id="action_account_move_sale_withhold"
        model="ir.actions.act_window"
    >
        <field name="name">Sale Withholds</field>
        <field name="res_model">account.move</field>
        <field name="view_mode">tree,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'tree', 'view_id': ref('l10n_ec_withhold.view_account_move_withhold_tree')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('l10n_ec_withhold.view_account_move_withhold_form')})]"/>
        <field name="domain">[('l10n_ec_withholding_type', '=', 'sale')]</field>
    </record>
</odoo>
